<!-- THIS FILE IS A CUSTOM RECEIVER FOR GOOGLE CAST DEVICES-->
<!-- PUBLISHED TO GITHUB - NOT IN LOCAL USAGE-->
<!DOCTYPE html>
<html>
<head>
    <title>SmartPlayer Custom Receiver</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Load the Cast Receiver Framework (CAF) -->
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden;
            font-family: sans-serif;
        }

        /* The main player element - MUST extend to full screen */
        cast-media-player {
            --splash-image: url('https://picsum.photos/1920/1080'); /* Optional splash screen */
            --progress-color: #FF0000;
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        /* Debug Overlay - Visible on TV so you can see why it fails */
        #debug {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #00FF00; /* Hacker Green */
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            font-size: 14px;
            width: 80%;
            max-height: 400px;
            overflow: hidden;
            z-index: 9999;
            display: none; /* Change to 'block' if you want to see logs on TV */
        }
    </style>
</head>
<body>

<!-- The built-in CAF player UI -->
<cast-media-player id="player"></cast-media-player>

<!-- Debug logging container -->
<div id="debug"></div>

<script>
    // --- LOGGER UTILITY ---
    // Change this to true to see logs on your TV screen
    const DEBUG_MODE = true;

    function log(msg) {
        console.log(msg);
        if (DEBUG_MODE) {
            const debugEl = document.getElementById('debug');
            debugEl.style.display = 'block';
            const line = document.createElement('div');
            line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            debugEl.insertBefore(line, debugEl.firstChild);
        }
    }

    // --- RECEIVER INITIALIZATION ---
    const context = cast.framework.CastReceiverContext.getInstance();
    const playerManager = context.getPlayerManager();

    // 1. CONFIG: Optimize for HLS (M3U8)
    const playbackConfig = new cast.framework.PlaybackConfig();
    playbackConfig.autoResumeDuration = 5;

    // Anti-CORS trick: do not send credentials/cookies with segment requests
    playbackConfig.segmentRequestCredentials = false;
    playbackConfig.manifestRequestCredentials = false;

    // 2. INTERCEPTOR: The most powerful part of Custom Receiver
    // This runs before the video tries to load.
    playerManager.setMessageInterceptor(
        cast.framework.messages.MessageType.LOAD,
        request => {
            log("LOAD request received!");

            if (request.media && request.media.contentId) {
                const url = request.media.contentId;
                log("Stream URL: " + url);

                // VALIDATION #1: Check if URL is valid
                if (!url || url.trim() === '') {
                    log("ERROR: Empty URL received!");
                    return null; // Reject the request
                }

                // VALIDATION #2: Check protocol
                if (url.startsWith('http://')) {
                    log("âš ï¸ WARNING: HTTP detected - upgrading to HTTPS");
                    request.media.contentId = url.replace('http://', 'https://');
                } else if (!url.startsWith('https://')) {
                    log("âŒ ERROR: Invalid protocol. Only HTTP/HTTPS supported.");
                    log("âŒ Received URL: " + url);
                    return null; // Reject the request
                }

                // VALIDATION #3: Check if it looks like M3U8
                if (!url.includes('.m3u8') && !url.includes('workers.dev') && !url.includes('mpegurl')) {
                    log("âš ï¸ WARNING: URL doesn't appear to be M3U8 format");
                    log("âš ï¸ This might fail. URL: " + url);
                }

                // Force content type if missing
                if (!request.media.contentType) {
                    request.media.contentType = 'application/x-mpegurl';
                    log("Set content type to: application/x-mpegurl");
                }

                // Log final URL that will be used
                log("âœ… Final URL: " + request.media.contentId);
                log("âœ… Content Type: " + request.media.contentType);
            } else {
                log("âŒ ERROR: No media or contentId in request");
                return null;
            }
            return request;
        }
    );

    // 3. ERROR LISTENER with detailed categorization
    playerManager.addEventListener(
        cast.framework.events.EventType.ERROR,
        event => {
            log("âŒâŒâŒ ERROR OCCURRED âŒâŒâŒ");
            log("Error Code: " + event.error);

            // Detailed error breakdown
            if (event.detailedErrorCode) {
                log("Detailed Error Code: " + event.detailedErrorCode);

                // Common error codes and their meanings
                const errorMeanings = {
                    'MEDIA_ERROR_MESSAGE': 'The media could not be loaded',
                    'NETWORK_ERROR': 'Network connection failed',
                    'MANIFEST_ERROR': 'M3U8 playlist is malformed or inaccessible',
                    'SEGMENT_ERROR': 'Failed to download video segments',
                    'CORS_ERROR': 'Cross-Origin Resource Sharing blocked',
                };

                const errorType = event.detailedErrorCode.toString();
                if (errorMeanings[errorType]) {
                    log("Meaning: " + errorMeanings[errorType]);
                }
            }

            // Log the stream URL that failed
            const currentMedia = playerManager.getMediaInformation();
            if (currentMedia && currentMedia.contentId) {
                log("Failed URL: " + currentMedia.contentId);

                // Provide diagnostic hints
                if (currentMedia.contentId.startsWith('http://')) {
                    log("ðŸ’¡ HINT: HTTP streams often fail. Use HTTPS or proxy.");
                }
                if (!currentMedia.contentId.includes('.m3u8')) {
                    log("ðŸ’¡ HINT: URL doesn't contain .m3u8 - might not be HLS stream.");
                }
            }

            log("Full Error Object: " + JSON.stringify(event));
        }
    );

    // 4. PLAYER STATE LISTENER
    playerManager.addEventListener(
        cast.framework.events.EventType.PLAYER_STATE_CHANGED,
        event => {
            log("State: " + event.playerState);
        }
    );

    log("Starting Receiver Manager...");

    // Start the receiver
    context.start({
        playbackConfig: playbackConfig,
        // Keep receiver alive for 5 minutes if idle
        maxInactivity: 300
    });

</script>
</body>
</html>
